#!/bin/bash

# --- Configuration & Styling ---
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/ytc"
mkdir -p "$CACHE_DIR"

play_submenu() {
    local id="$1"
    local title="$2"

    choice=$(printf "1. Play in MPV\n2. Open in Browser\n3. Back to List" | fzf \
        --header "Action for: $title" --height 10% --reverse --border)

    case "$choice" in
        *"MPV"*)
            clear
            mpv "https://www.youtube.com/watch?v=$id"  
            clear
            ;;
        *"Browser"*) 
            xdg-open "https://www.youtube.com/watch?v=$id" 2>/dev/null || open "https://www.youtube.com/watch?v=$id" 
            ;;
        *)
            return 
            ;;
    esac
}

fetch_and_play() {
    local feed_url="$1"
    local feed_name="$2"
    local page_size=50
    local start_index=1

    while true; do
        local end_index=$((start_index + page_size - 1))
        echo "Loading $feed_name (Items $start_index to $end_index)..."
        
        # Fetching data using yt-dlp
        yt-dlp --cookies-from-browser firefox \
                --flat-playlist \
                --playlist-items "$start_index:$end_index" \
                --no-check-certificates --no-warnings \
                --print "%(title)s" --print "%(id)s" --print "%(duration_string)s" \
                "$feed_url" 2>/dev/null | tr -d '\r' | paste - - - > "$CACHE_DIR/list.txt"

        # Inject Pagination controls
        {
            printf ">> NEXT PAGE\tPAGE_NEXT\t--\n"
            [ $start_index -gt 1 ] && printf "<< PREVIOUS PAGE\tPAGE_PREV\t--\n"
            cat "$CACHE_DIR/list.txt"
        } > "$CACHE_DIR/temp_list.txt" && mv "$CACHE_DIR/temp_list.txt" "$CACHE_DIR/list.txt"

        while true; do
            selected=$(cat "$CACHE_DIR/list.txt" | fzf \
                --delimiter $'\t' --tabstop=4 --with-nth 1,3 \
                --header "[$feed_name | Items $start_index-$end_index] ENTER: Select | ESC: Main Menu" \
                --preview "
                    id=\$(echo {2})
                    if [ \"\$id\" = \"PAGE_NEXT\" ] || [ \"\$id\" = \"PAGE_PREV\" ]; then
                        echo \"Navigate to results...\"
                    else
                        thumb_path=\"$CACHE_DIR/\$id.jpg\"
                        [ ! -f \"\$thumb_path\" ] && curl -s -o \"\$thumb_path\" \"https://img.youtube.com/vi/\$id/hqdefault.jpg\"
                        # Use \033[1;37m for Bold White text in the preview
                        printf \"\033[1;37mTITLE:\033[0m {1}\n\"
                        printf \"\033[1;37mTIME:\033[0m  {3}\n\"
                        echo \"------------------------------------\"
                        # Optional: Added --colors 2 for grayscale-ish output if chafa supports it
                        command -v chafa >/dev/null && chafa --size=80x40 \"\$thumb_path\"
                    fi
                " --preview-window=right:60%:wrap)

            [ -z "$selected" ] && return 

            v_title=$(echo "$selected" | cut -f1)
            v_id=$(echo "$selected" | cut -f2)
            v_dur=$(echo "$selected" | cut -f3)

            if [ "$v_id" = "PAGE_NEXT" ]; then
                start_index=$((start_index + page_size))
                break 
            elif [ "$v_id" = "PAGE_PREV" ]; then
                start_index=$((start_index - page_size))
                [ $start_index -lt 1 ] && start_index=1
                break 
            else
                play_submenu "$v_id" "$v_title" "$v_dur"
            fi
        done
    done
}

# --- Main Menu ---
while true; do
    choice=$(printf "1. Home\n2. Subscriptions\n3. Watch Later\n4. Search\n5. History\n6. Quit" | fzf \
        --header "YTC: Select Feed" --height 20% --reverse --border --prompt="> ")

    case "$choice" in
        *"Home"*)          fetch_and_play "https://www.youtube.com/" "Home" ;;
        *"Subscriptions"*) fetch_and_play "https://www.youtube.com/feed/subscriptions" "Subscriptions" ;;
        *"Watch Later"*)   fetch_and_play "https://www.youtube.com/playlist?list=WL" "Watch Later" ;;
        *"Search"*)
            # Note: gum input uses its own styling. 
            query=$(gum input --placeholder "Search YouTube...")
            if [ $? -eq 0 ] && [ ! -z "$query" ]; then
                fetch_and_play "ytsearch500:$query" "Search: $query"
            fi
            ;;
        *"History"*)       fetch_and_play "https://www.youtube.com/feed/history" "History" ;;
        *"Quit"*|*)        exit 0 ;;
    esac
done
